<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Pok√©mon Stadium - Online Lobby</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mona+Sans:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; }
        
        :root {
            --bg-deep: #0d0c04;
            --bg-main: #1a1708;
            --bg-card: #2d2810;
            --bg-input: #1a1708;
            --border: #a08020;
            --border-dim: #605010;
            --gold: #ffd93d;
            --gold-dark: #f0c000;
            --gold-deeper: #d4a800;
            --text: #e6edf3;
            --text-muted: #8b949e;
            --text-dim: #6e7681;
            --red: #ff6b6b;
            --blue: #6b8bff;
            --purple: #8060e0;
            --green: #50c878;
            --glow: rgba(240, 192, 0, 0.15);
        }
        
        body {
            background: var(--bg-deep);
            background-image: 
                radial-gradient(ellipse at top, var(--glow) 0%, transparent 50%),
                radial-gradient(circle at 20% 80%, rgba(255, 107, 107, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(128, 96, 224, 0.05) 0%, transparent 40%);
            min-height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Mona Sans', -apple-system, sans-serif;
            padding: 20px;
            color: var(--text);
            -webkit-user-select: none;
            user-select: none;
        }
        
        .lobby-container {
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* Header */
        .lobby-header {
            text-align: center;
            padding: 20px 0 10px;
        }
        .lobby-icon { font-size: 48px; margin-bottom: 8px; }
        .lobby-title {
            font-size: 28px;
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 0 30px rgba(240,192,0,0.3);
            letter-spacing: 1px;
        }
        .lobby-subtitle {
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
            letter-spacing: 3px;
            margin-top: 4px;
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border: 2px solid var(--border-dim);
            border-radius: 12px;
            padding: 20px;
            transition: border-color 0.2s;
        }
        .card:hover { border-color: var(--border); }
        
        .card-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 14px;
            text-transform: uppercase;
        }
        .card-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-dim);
        }
        
        .card-desc {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
            line-height: 1.5;
        }
        
        /* Player 1 - Create Room */
        .p1-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--gold-deeper);
            color: #000;
            font-size: 10px;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            padding: 3px 10px;
            border-radius: 20px;
            letter-spacing: 1px;
        }
        .p2-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--purple);
            color: #fff;
            font-size: 10px;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            padding: 3px 10px;
            border-radius: 20px;
            letter-spacing: 1px;
        }
        
        .btn {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 700;
            font-family: 'Mona Sans', sans-serif;
            cursor: pointer;
            transition: all 0.15s;
            letter-spacing: 1px;
        }
        .btn:active { transform: translateY(2px); }
        
        .btn-gold {
            background: linear-gradient(145deg, var(--gold-dark), var(--gold-deeper));
            color: #000;
            border-color: #8a7000;
            box-shadow: 0 4px 0 #8a7000, 0 6px 20px rgba(240,192,0,0.2);
        }
        .btn-gold:active { box-shadow: 0 1px 0 #8a7000; }
        .btn-gold:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-purple {
            background: linear-gradient(145deg, #6040c0, #4830a0);
            color: #fff;
            border-color: #302060;
            box-shadow: 0 4px 0 #302060, 0 6px 20px rgba(128,96,224,0.2);
        }
        .btn-purple:active { box-shadow: 0 1px 0 #302060; }
        .btn-purple:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Friend Code Display */
        .code-display {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-deep);
            border: 1px solid var(--border-dim);
            border-radius: 8px;
        }
        .code-display.show { display: flex; }
        
        .code-label {
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
            letter-spacing: 2px;
        }
        .code-value {
            font-size: 32px;
            font-weight: 900;
            font-family: 'JetBrains Mono', monospace;
            color: var(--gold);
            letter-spacing: 6px;
            text-shadow: 0 0 20px rgba(240,192,0,0.4);
        }
        .code-copy {
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            padding: 6px 14px;
            cursor: pointer;
        }
        .code-copy:hover { color: var(--gold); border-color: var(--border); }
        
        .waiting-msg {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        .waiting-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--gold);
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        /* Join Input */
        .join-row {
            display: flex;
            gap: 8px;
        }
        .join-input {
            flex: 1;
            padding: 12px 14px;
            background: var(--bg-input);
            border: 2px solid var(--border-dim);
            border-radius: 8px;
            color: var(--text);
            font-size: 18px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            letter-spacing: 4px;
            text-align: center;
            text-transform: uppercase;
        }
        .join-input:focus { outline: none; border-color: var(--purple); }
        .join-input::placeholder { color: var(--text-dim); letter-spacing: 2px; font-size: 13px; }
        
        .join-btn {
            padding: 12px 20px;
            background: linear-gradient(145deg, #6040c0, #4830a0);
            border: 2px solid #302060;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }
        .join-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Status */
        .status-bar {
            text-align: center;
            padding: 10px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-dim);
        }
        .status-bar.error { color: var(--red); }
        .status-bar.success { color: var(--green); }
        
        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-dim);
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 2px;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-dim), transparent);
        }
        
        /* Connected overlay */
        .connected-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        .connected-overlay.show { display: flex; }
        .connected-icon { font-size: 64px; animation: bounce 1s ease-in-out; }
        @keyframes bounce { 0%,100% { transform: scale(1); } 50% { transform: scale(1.3); } }
        .connected-text { font-size: 22px; font-weight: 800; color: var(--green); letter-spacing: 2px; }
        .connected-sub { font-size: 13px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .connected-countdown { font-size: 48px; font-weight: 900; color: var(--gold); font-family: 'JetBrains Mono', monospace; }
    </style>
</head>
<body>
    <div class="lobby-container">
        <div class="lobby-header">
            <div class="lobby-icon">‚ö°</div>
            <div class="lobby-title">Pok√©mon Stadium</div>
            <div class="lobby-subtitle">ONLINE BATTLE LOBBY</div>
        </div>
        
        <!-- Player 1: Create Room -->
        <div class="card" id="p1-card">
            <div class="card-label"><span class="p1-badge">‚ö° PLAYER 1</span></div>
            <div class="card-desc">Create a room and share the friend code with Player 2.</div>
            <button class="btn btn-gold" id="create-btn" onclick="createRoom()">‚ö° Generate Friend Code</button>
            <div class="code-display" id="code-display">
                <div class="code-label">YOUR FRIEND CODE</div>
                <div class="code-value" id="code-value">----</div>
                <button class="code-copy" id="code-copy" onclick="copyCode()">üìã Copy Code</button>
                <div class="waiting-msg">
                    <div class="waiting-dot"></div>
                    <span id="waiting-text">Waiting for Player 2...</span>
                </div>
            </div>
        </div>
        
        <div class="divider">OR</div>
        
        <!-- Player 2: Join Room -->
        <div class="card" id="p2-card">
            <div class="card-label"><span class="p2-badge">üéÆ PLAYER 2</span></div>
            <div class="card-desc">Enter the friend code from Player 1 to join their room.</div>
            <div class="join-row">
                <input type="text" class="join-input" id="join-input" placeholder="ENTER CODE" maxlength="6" autocomplete="off" spellcheck="false">
                <button class="join-btn" id="join-btn" onclick="joinRoom()">JOIN</button>
            </div>
        </div>
        
        <div class="status-bar" id="status-bar">Ready to connect</div>
    </div>
    
    <!-- Connected overlay -->
    <div class="connected-overlay" id="connected-overlay">
        <div class="connected-icon">‚öîÔ∏è</div>
        <div class="connected-text">CONNECTED!</div>
        <div class="connected-sub" id="connected-role">You are Player 1</div>
        <div class="connected-countdown" id="countdown">3</div>
        <div class="connected-sub">Launching Pok√©mon Stadium...</div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script>
        // ============ CONFIG - UPDATE THIS TO YOUR GITHUB PAGES URL ============
        const EMULATOR_URL = 'emulator.html';
        // ======================================================================
        
        let peer = null;
        let conn = null;
        let myRole = null; // 'p1' or 'p2'
        let roomCode = '';
        
        const statusBar = document.getElementById('status-bar');
        
        function setStatus(msg, type = '') {
            statusBar.textContent = msg;
            statusBar.className = 'status-bar' + (type ? ' ' + type : '');
        }
        
        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
            return code;
        }
        
        // ===== PLAYER 1: CREATE ROOM =====
        function createRoom() {
            const btn = document.getElementById('create-btn');
            btn.disabled = true;
            btn.textContent = 'Creating...';
            setStatus('Connecting to server...');
            
            roomCode = generateCode();
            const peerId = 'pkstadium-' + roomCode;
            
            peer = new Peer(peerId, {
                debug: 1,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', () => {
                myRole = 'p1';
                document.getElementById('code-value').textContent = roomCode;
                document.getElementById('code-display').classList.add('show');
                btn.textContent = 'Room Created!';
                setStatus('Room ready - share your code!', 'success');
                
                // Disable P2 join while hosting
                document.getElementById('join-input').disabled = true;
                document.getElementById('join-btn').disabled = true;
                document.getElementById('p2-card').style.opacity = '0.4';
            });
            
            peer.on('connection', (connection) => {
                conn = connection;
                conn.on('open', () => {
                    document.getElementById('waiting-text').textContent = 'Player 2 connected!';
                    setStatus('Player 2 connected!', 'success');
                    // Send confirmation
                    conn.send({ type: 'matched', role: 'p2' });
                    launchEmulator('p1');
                });
                conn.on('error', (err) => {
                    setStatus('Connection error: ' + err, 'error');
                });
            });
            
            peer.on('error', (err) => {
                console.error('Peer error:', err);
                if (err.type === 'unavailable-id') {
                    // Code collision, try again
                    peer.destroy();
                    btn.disabled = false;
                    btn.textContent = '‚ö° Generate Friend Code';
                    setStatus('Code taken, try again', 'error');
                } else {
                    setStatus('Error: ' + err.type, 'error');
                    btn.disabled = false;
                    btn.textContent = '‚ö° Generate Friend Code';
                }
            });
        }
        
        // ===== PLAYER 2: JOIN ROOM =====
        function joinRoom() {
            const input = document.getElementById('join-input');
            const code = input.value.trim().toUpperCase();
            if (code.length < 4) {
                setStatus('Enter a valid friend code', 'error');
                return;
            }
            
            const btn = document.getElementById('join-btn');
            btn.disabled = true;
            btn.textContent = '...';
            setStatus('Connecting to Player 1...');
            
            // Disable P1 create while joining
            document.getElementById('create-btn').disabled = true;
            document.getElementById('p1-card').style.opacity = '0.4';
            
            const peerId = 'pkstadium-p2-' + code + '-' + Date.now();
            
            peer = new Peer(peerId, {
                debug: 1,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', () => {
                myRole = 'p2';
                roomCode = code;
                const hostId = 'pkstadium-' + code;
                conn = peer.connect(hostId, { reliable: true });
                
                conn.on('open', () => {
                    setStatus('Connected to Player 1!', 'success');
                });
                
                conn.on('data', (data) => {
                    if (data.type === 'matched') {
                        launchEmulator('p2');
                    }
                });
                
                conn.on('error', (err) => {
                    setStatus('Connection failed: ' + err, 'error');
                    btn.disabled = false;
                    btn.textContent = 'JOIN';
                    document.getElementById('create-btn').disabled = false;
                    document.getElementById('p1-card').style.opacity = '1';
                });
            });
            
            peer.on('error', (err) => {
                console.error('Peer error:', err);
                if (err.type === 'peer-unavailable') {
                    setStatus('Room not found. Check the code.', 'error');
                } else {
                    setStatus('Error: ' + err.type, 'error');
                }
                btn.disabled = false;
                btn.textContent = 'JOIN';
                document.getElementById('create-btn').disabled = false;
                document.getElementById('p1-card').style.opacity = '1';
            });
        }
        
        // ===== LAUNCH EMULATOR =====
        function launchEmulator(role) {
            const overlay = document.getElementById('connected-overlay');
            overlay.classList.add('show');
            document.getElementById('connected-role').textContent = 
                role === 'p1' ? 'You are Player 1 (Gold Controller)' : 'You are Player 2 (Purple Controller)';
            
            let count = 3;
            const cd = document.getElementById('countdown');
            const timer = setInterval(() => {
                count--;
                cd.textContent = count;
                if (count <= 0) {
                    clearInterval(timer);
                    // Navigate to emulator with params
                    const params = new URLSearchParams({
                        player: role === 'p1' ? '1' : '2',
                        room: roomCode
                    });
                    window.location.href = EMULATOR_URL + '?' + params.toString();
                }
            }, 1000);
        }
        
        // ===== COPY CODE =====
        function copyCode() {
            navigator.clipboard.writeText(roomCode).then(() => {
                const btn = document.getElementById('code-copy');
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => btn.textContent = 'üìã Copy Code', 2000);
            }).catch(() => {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = roomCode;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                ta.remove();
                const btn = document.getElementById('code-copy');
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => btn.textContent = 'üìã Copy Code', 2000);
            });
        }
        
        // Auto-uppercase join input
        document.getElementById('join-input').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });
        
        // Enter key to join
        document.getElementById('join-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') joinRoom();
        });
    </script>
</body>
</html>
